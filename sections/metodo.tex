\chapter{Metodologia}
\section{Desempenho Computacional}
Três abordagens distintas serão consideradas nessa parte: A utilização de um 
\textit{cluster}, Python na sua implementação original (CPython) e Cython.
As medições do tempo de execução, realizadas por meio da biblioteca \textit{time},
levarão em conta apenas os trechos do código
que se repetem várias vezes e que, consequentemente, contém os maiores
``gargalos'' na simulação.

\subsection{Cluster Águia}
O \textit{cluster} Águia é composto por 64 servidores físicos com 20 \textit{cores} e 
512 GB de RAM. Seu processador é um Intel(R) Xeon(R) CPU E7-2870 com 2.4 GHz.
A versão do Python disponível para utilização nesse sistema é 2.7.13, da
distribuição Anaconda2 4.4.0.

Primeiramente, o uso de ferramentas para passagem de mensagens em um sistema
distribuído será analisado para simulações simples, com uma corrente injetada
de 10 nA no soma de MNs. O cálculo da força gerada também será computado.
Para esse fim, o pacote
Python MPI4Py, que possibilita o uso do todos os recursos do \textit{cluster},
será utilizado. Serão utilizados 2, 4, 8 e 16 processos em um único servidor.

Para possibilitar que o problema abordado pudesse ser divididos em unidades menores
de computação, foram identificados algumas \textit{tasks} primitivas: os cálculos
da força e das equações diferenciais das unidades motoras. As unidades
motoras são independentes entre si e não precisam receber mensagens durante a
simulação, mas a parte de cálculo de força precisa receber, a cada passo de
tempo, valores relativos de disparos das unidades motoras. Sendo assim,  as
unidades motoras enviam, no final de cada passo da simulação,
seus valores de disparos para as \textit{tasks} de cálculo de força, que
apenas as recebem e realizam suas computações.

As computações das unidades
motoras serão divididas igualmente entre os processos criados, 
enquanto que a \textit{task} de cálculo da força deve ocupar sozinha um único
processo. Os parâmetros que serão usados para analisar a qualidade do programa
paralelo são o \textit{speed up} (ou aceleração), calculado pela equação

\begin{equation}
    S = \frac{t_s}{t_p},
\label{eq:speedup}
\end{equation}

em que $t_s$ e $t_p$ são o tempo de execução serial e paralelo, respectivamente,
e a eficiência, calculada por

\begin{equation}
    E = \frac{t_s}{N t_p},
\end{equation}

sendo $N$ o número de processadores utilizados.

Os valores de $t_s$ e $t_p$ são obtidos a partir da média de 10 simulações com
400 unidades motoras e duração de 0.5 segundos.

\subsection{Python}
Essa estratégia se baseia no uso do conceito de vetorização. O código atual 
utiliza uma matriz de condutâncias de cada compartimento do modelo para
realizar cálculos sobre os potenciais de membrana. O objetivo é criar uma
matriz maior que contenha cada uma dessas matrizes menores, de forma que o 
processo de vetorização possa trazer otimizações. Isso será realizado para 
todos os MNs, INs e algumas outras variáveis envolvidas no cálculo do potencial
de membrana. A implementação antiga das matrizes será identificada como $G_c$ e
a nova proposta, como $G_g$.

Nessa parte será utilizado um sistema operacional Linux
64 bits com oito processadores Intel Core i7-2600 a 3.40 GHz e 7.8 GB de RAM.
A versão do Python utilizada é a 2.7.14, da distribuição Anaconda2 5.0.1-1.
De forma geral, as simulações consistirão de comandos descendentes ativando
MNs.
O tempo de execução será obtido a partir da média de 5 resultados
para diferentes quantidades de MNs
(variação no tamanho da matriz de condutância).

\subsection{Cython}
A biblioteca relativa a esse compilador pode ser carregada de forma simples no
Python. A estrutura do código, entretanto, terá que passar por algumas
modificações. De forma geral, as maiores diferenças entre um código que usa
Cython um com Python puro são algumas chamadas de funções e declaração de
variáveis. Considerando o tamanho e complexidade do código do simulador e o
fato de algumas declarações do Cython serem opcionais, pretende-se iniciar uma
conversão de uma parte desse código, de forma que, ao final desse processo, os
módulos principais usados nas simulações possam ser compilados com
Cython. A métrica usada para medir o ganho de desempenho é a mesma da 
Equação (\ref{eq:speedup}), mas usando os tempos de execução das soluções em 
Python e Cython.

\section{Estudo das Parametrizações}
O modelo estudado aqui passará por etapas de comparação com resultados descritos
na literatura. Inicialmente, as parametrizações antiga e nova serão usadas 
nessas avaliações, mas a ideia é que se tenha uma nova parametrização ao final 
desse processo que será usada nos estudos de variabilidade de força
explicitados na seção \ref{sec:for}.

\subsection{Validação do Modelo}
Essa etapa será realizada de forma qualitativa e semiquantitativa.
Em primeiro lugar, serão 
analisadas características de frequência e padrão de disparos de MNs e CRs,
assim como a ordem de recrutamento de MNs sob o efeito das CRs.

As simulações para esse estudo foram
realizadas em um núcleo motor do músculo soleus, com 800 MNs do tipo S, 50 do
tipo FR, 50 do tipo FF e 350 CRs. Essas quantidades foram estimadas a partir de
dados experimentais de humanos \cite{cisi08}. Foi injetada no soma dos MNs uma
corrente em rampa. Esta corrente injetada começa em zero e
aumenta linearmente até o valor final de 20 nA ao final da simulação, que teve
duração de 1000 ms. Os
instantes de disparos dos neurônios envolvidos na simulação serão analisados.
Além disso, espera-se que a inibição recorrente não altere a ordem de 
recrutamento dos MNs \cite{clamann74}.

Em segundo lugar, serão analisados características de pós hiperpolarização 
das CRs, PIPS nos MNs e PEPS nas CRs. Como esses são aspectos importantes
do circuito de inibição recorrente, é importante que o modelo, independente 
da parametrização, possa reproduzir esses dados descritos na literatura.
Caso esse não seja o caso, novos parâmetros serão estimados.

Muitas vezes, o alto grau de liberdade de um modelo pode dificultar
a obtenção de parâmetros que o adequem à dados experimentais. Para 
essas situações, será utilizada a abordagem de estratégias evolutivas
da classe de algoritmos evolutivos disponibilizados no \textit{inspyred},
que é uma biblioteca do Python para encontrar parâmetros de redes
neuronais capazes de reproduzir determinadas propriedades. De forma
geral, os parâmetros escolhidos são iterativamente alterados até 
que se obtenha uma rede neuronal com a característica próxima à
desejada.

Sendo assim, as constantes de tempo e condutâncias máximas dos canais
de potássio da CR serão ajustado para reproduzir as características
de 2 mV de amplitude e 30 ms de duração de sua pós hiperpolarização
\cite{hultborn79}, como mostrado na Figura \ref{fig:HP79}\subref{fig:AHPRC}. Essa
duração, como proposto por \cite{maltenfort98},
foi também alcançada fixando o valor de constante de tempo da membrana
em aproximadamente 8 ms. Para testar a robustez da parametrização 
obtida, o modelo será comparado com características de corrente injetada
e taxa de disparo, mostrada na Figura \ref{fig:HP79}\subref{fig:fxiRC}.

\begin{figure}[ht]
    \centering
    \subfloat[][]{
        \label{fig:AHPRC}
        \includegraphics[scale=0.5]{AHPRC}
    }
    \hspace{-1cm}
    \subfloat[][]{
        \label{fig:fxiRC}
        \includegraphics[scale=0.4]{fxiRC}
    }
    \caption[Características de disparos disparos da célula de Renshaw
            \cite{hultborn79}]{
        Características de disparos disparos da célula de Renshaw
        \cite{hultborn79}. \subref{fig:AHPRC} Detalhes de
        amplitude e duração da pós hiperpolarização.
        \subref{fig:fxiRC} Relação entre corrente injetada e
        taxa de disparo de uma célula de Renshaw.
         }
    \label{fig:HP79}
\end{figure}

As condutâncias máximas, bem como sua constante de tempo, foram
parametrizadas para reproduzir um PEPS causado nas CRs por MNs
de 7.6 ms de tempo de subida, 50 ms de duração e 0.6 mV de pico
para um estímulo antidrômico \cite{walmsley81}, como mostrado na Figura
\ref{fig:PEPS}. Nesse caso, os diferentes
níveis de excitação fornecidos por cada tipo de MN serão 
considerados como condutâncias seguindo as proporções descritas
por \citeonline{hultborn88a}.

\begin{figure}[ht]
	\center
	\includegraphics[scale=0.7]{PEPS}
	\caption{Potencial excitatório pós sináptico recorrente em uma
             célula de Rewshaw \cite{walmsley81}.}
	\label{fig:PEPS}
\end{figure}

Por fim, valores de condutância e constante de tempo de decaimento 
serão parametrizados para que a média dos PIPS causados pelas CRs 
em todos os MNs seja o mesmo valor médio de 12.7 $\mu$V observado por
\citeonline{vankeulen79}. A Figura \ref{fig:PIPS} mostra o resultado
obtido pelos autores, sendo que, a partir disso,
\citeonline{hamm87b} mediram tempo de subida e tempo de meia vida
no intervalos de 2-12 ms e 7-14 ms, respectivamente.
Nessa caso, as condutâncias serão comparadas
com os valores medidos por \citeonline{maltenfort04}, que tem média de 
23-27 nS e varia dentro do intervalo de 6.7 nS até 57.9 nS. Para
testar a robustez da parametrização, também serão testados os 
comportamentos de amplitude, latência, tempo de subida, decaimento
com a distância e tempo de 
meia vida, que também podem estar relacionados com a conectividade
\cite{hamm87a,hamm87b,mccurdy94}. A sinapse em questão será
posicionada no compartimento dendrítico do MN.

\begin{figure}[ht]
	\center
	\includegraphics[scale=0.6]{PIPS}
    \caption[Potencial excitatório pós sináptico recorrente em um
             motoneurônio]{
                Potencial excitatório pós sináptico recorrente em um
                motoneurônio. Os gráficos representam a média de potenciais
                de membrana quando há um disparo, sendo que a linha
                pontilhada está posicionada 1 ms após o inicio desse disparo.
                O painel do lado esquerdo mostra o resultado para uma única 
                célula, enquanto que o direito, para várias. Nas duas, a parte
                superior representa a resposta para um único disparo da célula
                de Renshaw, enquanto que a inferior, para dois \cite{vankeulen79}.}
	\label{fig:PIPS}
\end{figure}

\subsection{Comparações entre Modelos}
O objetivo desta etapa é entender como o simulador aqui estudado se comporta 
em algumas situações propostas por outros trabalhos de simulação. Dessa forma,
serão configuradas simulações que sejam o mais semelhante possível a esses 
trabalhos para que os resultados possam ser apropriadamente comparados.

Os trabalhos em questão, juntamente com os resultados que serão aqui abordados,
são apresentados abaixo. Vale ressaltar que os métodos utilizados para a 
obtenção dos resultados serão os mesmos empregados pelos autores, que foram
analisados com e sem CRs. Os trabalhos alvo são:

\begin{itemize}
	\item \citeonline{maltenfort98}, com foco no espectro de potência da atividade da
        população de MNs, de acordo com o que é mostrado na Figura
        \ref{fig:maltenfort98};
	\item \citeonline{uchiyama03b}, com relações de comandos descendentes com
		  taxa de disparos de MNs e CRs e força muscular resultante, de
          acordo com o que é mostrado na Figura \ref{fig:uchiyama03};
	\item \citeonline{williams09}, com espectro de potência dos disparos de uma
		  população de MNs e da força muscular, de acordo com o que é
          mostrado na Figura \ref{fig:williams09}.
\end{itemize}

\begin{figure}[ht]
	\center
	\includegraphics[scale=0.7]{maltenfort98}
    \caption[Espectro de potência da dos disparos de uma população de motoneurônios
             \cite{maltenfort98}]{Espectro de potência da atividade da
             população de motoneurônios para diferentes níveis de ativações e
             banda de frequências da entrada (A: 15 pps, com 65\% de
             recrutamento; B:21 pps, com 90\% de recrutamento; C: 30 pps, com
             100\% de recrutamento). Linhas grossas e finas são usadas para
             representar a presença e ausência de inibição recorrente, 
             respectivamente \cite{maltenfort98}.
             }
	\label{fig:maltenfort98}
\end{figure}

\begin{figure}[ht]
    \centering
    \subfloat[][]{
        \label{fig:uchiyama03a}
        \includegraphics[scale=0.4]{uchiyama03a}
    }
    ~
    \subfloat[][]{
        \label{fig:uchiyama03b}
        \includegraphics[scale=0.4]{uchiyama03b}
    }
    \caption[Relações de entrada (comando descendente) e saída (taxa
             de disparos) de motoneurônios e células de Renshaw
             \cite{uchiyama03b}]{Relações de entrada (comando descendente)
             e saída (taxa de disparos) de motoneurônios e células de
             Renshaw, com e sem inibição recorrente. \subref{fig:uchiyama03a}
             Motoneurônios. \subref{fig:uchiyama03b} Células de Renshaw.
             \cite{uchiyama03b}}
	\label{fig:uchiyama03}
\end{figure}

\begin{figure}[ht]
	\centering
    \subfloat[][]{
        \label{fig:williams09a}
        \includegraphics[scale=0.3]{williams09a}
    }
    ~
    \subfloat[][]{
        \label{fig:williams09b}
        \includegraphics[scale=0.3]{williams09b}
    }
    \caption[Efeitos da ausência e presença da célula de Renshaw em espectros de potência
             \cite{williams09}
            ]{Efeitos da ausência e presença da célula de Renshaw em espectros de potência:
             \cite{williams09} \subref{fig:williams09a} dos disparos de uma 
             população de motoneurônios. \subref{fig:williams09b} da força
             muscular.
             }
	\label{fig:williams09}
\end{figure}

\section{Variabilidade da Força}
\label{sec:for}
Para essa análise, dois cenários foram considerados: um que simule o controle
de força exercida pelo calcanhar em um pedal fixo e outro em um pedal livre.
Em ambos os casos, os primeiros 500 ms segundos do sinal da força gerada serão
ignorados. A quantidade de elementos neuronais é a mesma da mostrada
na seção anterior, mas o tempo de simulação foi estendido para 3500 ms.

Uma força a 20\% da contração máxima voluntária será tomada como referência e
o seu coeficiente de variação e sua densidade espectral de potência serão
calculados. Esses resultados serão analisados em simulações com e sem CRs.
Na ausência de inibição recorrente, os comandos descendentes agindo sobre
os MNs serão ajustados de forma a produzir a mesma taxa de disparo da
situação com CR.
